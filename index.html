<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Laboratorio Musical Geométrico</title>
<script src="https://cdn.jsdelivr.net/npm/tone@next"></script>
<style>
  body {
    margin:0;
    background:#0a0a0a;
    color:#fff;
    font-family:sans-serif;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:flex-start;
    height:100vh;
    overflow:hidden;
  }
  h1 { margin:20px; font-weight:300; color:#0ff; }
  #controls { margin:10px; display:flex; gap:10px; }
  button { padding:8px 12px; border:none; border-radius:5px; cursor:pointer; background:#111; color:#0ff; font-weight:600; transition:0.2s; }
  button:hover { background:#222; }
  svg { width:90vw; height:70vh; margin-top:20px; background:#0a0a0a; border-radius:10px; }
  .note-dot { fill:#0ff; transition: fill 0.1s, r 0.1s; }
  .active { fill:#ff0; r:8; }
  polygon { fill:none; stroke:#0ff; stroke-width:1.5; transition:stroke-width 0.1s; }
  polygon.active { stroke:#ff0; stroke-width:3; }
</style>
</head>
<body>

<h1>Laboratorio Musical Geométrico</h1>
<div id="controls">
  <button id="playBtn">Play</button>
  <button id="stopBtn">Stop</button>
  <button id="newPatternBtn">Nuevo Patrón</button>
</div>

<svg id="visualSVG"></svg>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  await Tone.start();

  const svg = document.getElementById('visualSVG');
  const width = svg.clientWidth;
  const height = svg.clientHeight;
  const centerX = width/2;
  const centerY = height/2;
  const radius = Math.min(width,height)/3;

  const rows = 5;
  const numVerticesOptions = [3,4,5,6,7];
  let currentPattern = [];

  const scales = {
    minor: ['C4','D4','Eb4','F4','G4','Ab4','Bb4','C5'],
    major: ['C4','D4','E4','F4','G4','A4','B4','C5'],
    pentatonic: ['C4','D4','E4','G4','A4','C5']
  };

  const synths = [
    new Tone.PolySynth(Tone.Synth, {volume:-6, oscillator:{type:'triangle'}}),
    new Tone.PolySynth(Tone.Synth, {volume:-8, oscillator:{type:'sine'}}),
    new Tone.PolySynth(Tone.FMSynth, {volume:-10}),
    new Tone.PolySynth(Tone.AMSynth, {volume:-10}),
    new Tone.MembraneSynth({volume:-6})
  ];

  const reverb = new Tone.Reverb({decay:4, wet:0.3}).toDestination();
  const delay = new Tone.FeedbackDelay("8n",0.3).toDestination();
  synths.forEach(s => s.connect(reverb).connect(delay));

  function generatePattern() {
    currentPattern = [];
    for(let r=0;r<rows;r++){
      const vertices = numVerticesOptions[Math.floor(Math.random()*numVerticesOptions.length)];
      const scaleKeys = Object.values(scales)[Math.floor(Math.random()*Object.keys(scales).length)];
      const stepPattern = [];
      for(let i=0;i<vertices;i++){
        stepPattern.push(scaleKeys[Math.floor(Math.random()*scaleKeys.length)]);
      }
      currentPattern.push({vertices, notes:stepPattern});
    }
  }

  const polygons = [];
  const dots = [];

  function drawPattern() {
    svg.innerHTML = '';
    polygons.length=0;
    dots.length=0;
    const rowSpacing = radius/rows;

    currentPattern.forEach((line,r)=>{
      const poly = document.createElementNS("http://www.w3.org/2000/svg","polygon");
      const points = [];
      for(let i=0;i<line.vertices;i++){
        const angle = (i/line.vertices)*Math.PI*2 - Math.PI/2;
        const x = centerX + (rowSpacing*(r+1)) * Math.cos(angle);
        const y = centerY + (rowSpacing*(r+1)) * Math.sin(angle);
        points.push(`${x},${y}`);

        const dot = document.createElementNS("http://www.w3.org/2000/svg","circle");
        dot.setAttribute('cx',x);
        dot.setAttribute('cy',y);
        dot.setAttribute('r',6);
        dot.setAttribute('class','note-dot');
        svg.appendChild(dot);
        dots.push({element:dot,note:line.notes[i]});
      }
      poly.setAttribute('points',points.join(' '));
      svg.appendChild(poly);
      polygons.push(poly);
    });
  }

  let step = 0;
  function playStep(time){
    dots.forEach(d=>d.element.classList.remove('active'));

    let noteCount=0;
    currentPattern.forEach(p=>{
      for(let i=0;i<p.vertices;i++){
        if(i===step){
          const dot = dots[noteCount];
          dot.element.classList.add('active');
          synths[Math.min(noteCount,synths.length-1)].triggerAttackRelease(dot.note,"8n",time);
        }
        noteCount++;
      }
    });
    polygons.forEach(poly=>{
      poly.classList.toggle('active', step%2===0);
    });

    step=(step+1)%Math.max(...currentPattern.map(p=>p.vertices));
  }

  const loop = new Tone.Loop(playStep, "8n");

  document.getElementById('playBtn').onclick = ()=>{
    loop.start(0);
    Tone.Transport.start();
  };
  document.getElementById('stopBtn').onclick = ()=>{
    loop.stop();
    Tone.Transport.stop();
    dots.forEach(d=>d.element.classList.remove('active'));
    polygons.forEach(p=>p.classList.remove('active'));
  };
  document.getElementById('newPatternBtn').onclick = ()=>{
    generatePattern();
    drawPattern();
    step=0;
  };

  generatePattern();
  drawPattern();

});
</script>
</body>
</html>
